<div class="flex h-screen w-full flex-col rounded-lg bg-foreground p-6">
  <!-- header -->
  <p class="text-2xl font-bold">Data</p>
  <p class="text-lg">Upload and manage different types of data.</p>

  <!-- search bar -->
  <div class="relative my-5 h-9 w-1/2 flex-none">
    <input
      class="h-full w-full rounded-xl border border-[#4F4F4F]/40 pl-10 text-sm focus:outline-none"
      placeholder="Search files..."
      [(ngModel)]="searchFilter"
      (input)="applySearchFilter()"
    />
    <i
      class="material-icons absolute left-2 top-[50%] translate-y-[-50%] text-[#9E9E9E]"
      >search</i
    >
  </div>

  <!-- directory labels -->
  <div class="flex items-center overflow-x-auto text-xl font-bold">
    @for (path of currentPathArray; track $index) {
      <button
        class="whitespace-nowrap rounded-lg bg-white p-1 hover:brightness-90"
        type="button"
        (click)="toPreviousDirectory($index)"
      >
        {{ $first ? 'My Files' : path }}
      </button>
      @if (!$last) {
        <i class="material-icons-outlined text-[#5f6368]">chevron_right</i>
      }
    }
  </div>

  <!-- filter/upload buttons row -->
  <div class="flex flex-none gap-x-4 py-3">
    @for (filter of filterButtons; track $index) {
      <button
        class="h-10 rounded-3xl border border-black px-4 text-sm font-semibold hover:bg-[#032D38] hover:text-white"
        type="button"
        [ngClass]="{
          'bg-[#032D38] text-white': filter.type == this.typeFilter,
        }"
        (click)="applyTypeFilter(filter.type)"
      >
        {{ filter.name }}
      </button>
    }
    <div
      class="relative ml-auto flex items-center gap-x-2 rounded-lg bg-[#038C7F] pl-3 pr-4 text-sm font-semibold text-white hover:brightness-90"
      type="button"
    >
      <i class="material-icons-outlined">file_upload</i>
      Upload data
      <input
        class="absolute left-0 top-0 h-full w-full opacity-0"
        type="file"
        (change)="onUploadFilesSelected($event)"
        multiple
      />
    </div>
    <button
      class="material-icons-outlined rounded-lg bg-[#038C7F] px-2 text-white hover:brightness-90"
      type="button"
      (click)="createFolderDialog.show()"
    >
      create_new_folder
    </button>
  </div>

  <!-- file directory table -->
  <div class="w-full overflow-y-auto">
    <table class="w-full table-fixed text-left text-sm">
      <!-- table header + sorting buttons -->
      <thead>
        <tr>
          <!-- weird CSS workaround to make the body scrollable. reference:
          https://www.geeksforgeeks.org/how-to-create-a-table-with-fixed-header-and-scrollable-body/#. maybe i should've just used flex columns... -->
          <!-- file name header -->
          <th class="sticky top-0 w-[30%] rounded-ss-lg bg-[#F1F1F1] px-4 py-3">
            <div class="flex items-center justify-between">
              File Name
              <button
                class="material-icons-outlined text-[#9E9E9E]"
                type="button"
                (click)="applySortFilter('name')"
              >
                {{ getSortDirectionMatIcon('name') }}
              </button>
            </div>
          </th>
          <!-- file type header -->
          <th class="sticky top-0 w-[15%] bg-[#F1F1F1] pr-4">
            <div class="flex items-center justify-between">
              File Type
              <button
                class="material-icons-outlined text-[#9E9E9E]"
                type="button"
                (click)="applySortFilter('type')"
              >
                {{ getSortDirectionMatIcon('type') }}
              </button>
            </div>
          </th>
          <!-- size header -->
          <th class="sticky top-0 w-[10%] bg-[#F1F1F1]">Size</th>
          <!-- last modified header -->
          <th class="sticky top-0 bg-[#F1F1F1] pr-4">
            <div class="flex items-center justify-between">
              Last Modified
              <button
                class="material-icons-outlined text-[#9E9E9E]"
                type="button"
                (click)="applySortFilter('uploadedOn')"
              >
                {{ getSortDirectionMatIcon('uploadedOn') }}
              </button>
            </div>
          </th>
          <!-- path header (only appears if searching) -->
          @if (this.searchFilter !== '') {
            <th class="sticky top-0 bg-[#F1F1F1]">Path</th>
          }
          <th
            class="sticky top-0 w-[15%] rounded-se-lg bg-[#F1F1F1] px-4 text-center"
          >
            Actions
          </th>
        </tr>
      </thead>
      <!-- file rows -->
      <tbody>
        <!-- display uploading files -->
        @for (
          upload of uploadService.getUploadProgress() | async;
          track upload.id
        ) {
          @if (
            searchFilter === '' &&
            pageNumber === 1 &&
            upload.uploadPath === currentPathString
          ) {
            <tr class="bg-white hover:brightness-90">
              <td class="truncate px-4 italic">
                <img
                  class="inline w-8 py-1 pr-3"
                  [src]="
                    upload.type === 'file'
                      ? getImageUrlFromType('unknown')
                      : getImageUrlFromType('folder')
                  "
                />
                {{ upload.name }}
              </td>
              <td class="truncate pr-4 italic">
                {{
                  upload.type === 'file' ? 'Uploading...' : 'Creating folder...'
                }}
              </td>
              <td></td>
              <td class="pb-1 pr-6">
                <brn-progress hlmProgress [value]="upload.progress" class="h-2">
                  <brn-progress-indicator hlmProgressIndicator />
                </brn-progress>
              </td>
              <td></td>
            </tr>
          }
        }
        <!-- display already stored files -->
        @for (file of displayedFiles; track file.id) {
          <tr
            class="bg-white hover:brightness-90"
            (dblclick)="file.isFolder ? toNextDirectory(file.name) : null"
          >
            <td class="truncate px-4">
              <img
                class="inline w-8 py-1 pr-3"
                [src]="getImageUrlFromType(file.type)"
              />
              {{ file.name }}
            </td>
            <td class="truncate pr-4">
              {{ file.type | titlecase }}
            </td>
            <td class="truncate pr-4">
              {{ !file.isFolder ? formatBytes(file.size) : '' }}
            </td>
            <td class="truncate pr-4">
              {{ file.uploadedOn.toLocaleDateString('en-US') }}
            </td>
            @if (this.searchFilter !== '') {
              <td class="truncate pr-4">
                {{ file.path }}
              </td>
            }
            <td class="overflow-hidden text-center text-[#4F4F4F]">
              <!-- downloading currently doesn't work (see FileStorageService) -->
              <!-- <button
              class="material-symbols-outlined p-0"
              type="button"
              (click)="downloadFileOrFolder(file)"
            >
              file_download
            </button> -->
              <button
                class="material-symbols-outlined align-middle"
                type="button"
                (click)="deleteFileOrFolder($event, file)"
              >
                delete
              </button>
            </td>
          </tr>
        }
      </tbody>
    </table>
  </div>

  <!-- No files uploaded state -->
  @if (userFiles?.length === 0 && userUploads?.length === 0) {
    <div class="mt-auto flex flex-col items-center gap-y-1">
      <img class="h-12 w-12" src="assets/twocube-logo-black-bg.png" />
      <p class="font-bold">No Files Yet</p>
      <p>Use the "Upload data" button to get started.</p>
    </div>
  }
  <!-- File search/filter empty state -->
  @else if (displayedFiles?.length === 0 && (searchFilter || typeFilter)) {
    <div class="mt-auto flex flex-col items-center gap-y-1">
      <img class="h-12 w-12" src="assets/twocube-logo-black-bg.png" />
      <p class="font-bold">File not found</p>
      <p class="text-center">
        {{
          searchFilter !== ''
            ? 'Your search "' + searchFilter + '" did not match any file.'
            : 'There are no "' + (typeFilter! | titlecase) + '" found.'
        }}
        <br />
        Please try again.
      </p>
    </div>
  }

  <!-- bottom page navigator -->
  <div class="mt-auto flex items-center justify-center gap-x-4 pr-6">
    <button
      class="text-sm text-[#9E9E9E]"
      type="button"
      (click)="previousPage()"
      [disabled]="pageNumber === 1"
    >
      Previous
    </button>

    <!-- 2 pages back number -->
    @if (pageNumber === totalPages && pageNumber > 2) {
      <button
        class="h-10 w-10 rounded-xl bg-[#E0E0E0] hover:brightness-90"
        type="button"
        (click)="setPage(pageNumber - 2)"
      >
        {{ pageNumber - 2 }}
      </button>
    }
    <!-- previous page number -->
    @if (pageNumber !== 1) {
      <button
        class="h-10 w-10 rounded-xl bg-[#E0E0E0] hover:brightness-90"
        type="button"
        (click)="setPage(pageNumber - 1)"
      >
        {{ pageNumber - 1 }}
      </button>
    }
    <!-- current page -->
    <button class="h-10 w-10 rounded-xl bg-[#024050] text-white">
      {{ pageNumber }}
    </button>
    <!-- next page -->
    @if (pageNumber !== totalPages) {
      <button
        class="h-10 w-10 rounded-xl bg-[#E0E0E0] hover:brightness-90"
        type="button"
        (click)="setPage(pageNumber + 1)"
      >
        {{ pageNumber + 1 }}
      </button>
    }
    <!-- 2 pages forward -->
    @if (pageNumber === 1 && totalPages > 2) {
      <button
        class="h-10 w-10 rounded-xl bg-[#E0E0E0] hover:brightness-90"
        type="button"
        (click)="setPage(pageNumber + 2)"
      >
        {{ pageNumber + 2 }}
      </button>
    }

    <button
      class="text-sm text-[#9E9E9E]"
      type="button"
      (click)="nextPage()"
      [disabled]="pageNumber === totalPages"
    >
      Next
    </button>
  </div>

  <!-- create folder dialog -->
  <dialog
    #createFolderDialog
    class="top-[50%] z-[100] w-80 translate-y-[-50%] rounded-xl border border-[#4F4F4F]/20 bg-white p-4 outline-none"
  >
    <div class="flex flex-col gap-y-3">
      <p class="text-xl font-semibold">Create new folder</p>
      <input
        class="w-full rounded-md border border-[#4F4F4F]/40 p-1 pl-2 text-sm focus:outline-none"
        placeholder="Enter folder name..."
        [(ngModel)]="createFolderName"
      />
      <div class="flex gap-x-2">
        <button
          class="rounded-lg bg-[#038C7F] px-3 py-1 text-sm font-semibold text-white hover:brightness-90"
          type="button"
          (click)="createFolder(); createFolderDialog.close()"
        >
          Submit
        </button>
        <button
          class="rounded-lg border border-[#4F4F4F]/40 px-3 py-1 text-sm font-semibold hover:brightness-90"
          type="button"
          (click)="createFolderDialog.close()"
        >
          Cancel
        </button>
      </div>
    </div>
  </dialog>
</div>
