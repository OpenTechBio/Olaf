<div class="flex h-screen p-3 bg-background">
  <!-- sidebar -->
  <div
    #sidebar
    id="sidebar"
    class="flex flex-col p-3 bg-foreground rounded-md gap-y-2 transition-[width]"
  >
    <!-- header/collapse button row -->
    <div
      class="flex-none flex items-center gap-x-2.5 overflow-x-hidden"
      [ngClass]="{ 'justify-center': collapsed }"
    >
      @if (!collapsed) {
        <img
          src="assets/twocube-logo-black-bg.png"
          class="flex-none w-8 h-8 rounded-lg"
        />
        <div hlmLarge class="mr-auto truncate">Twocube</div>
      }
      <button hlmBtn variant="ghost" size="icon" (click)="toggleSidebar()">
        <hlm-icon
          size="sm"
          [name]="collapsed ? 'lucidePanelLeftOpen' : 'lucidePanelLeftClose'"
        />
      </button>
    </div>
    <hr hlmSeparator />
    <!-- new session button -->
    <button
      hlmBtn
      variant="accent"
      size="sm"
      class="flex-none justify-start pl-2 gap-x-2 truncate"
      (click)="newSession()"
    >
      <hlm-icon size="sm" name="lucidePlus" class="flex-none" />
      @if (!collapsed) {
        <div class="truncate">New Session</div>
      }
    </button>
    <!-- sessions list -->
    @if (!collapsed) {
      <div class="flex flex-col gap-y-1 overflow-y-auto">
        @for (session of sessionsService.userSessions; track session.id) {
          @if (session.projectId === currentProject.id) {
            <button
              hlmBtn
              [variant]="
                currentSession.id === session.id ? 'accent' : 'ghost'
              "
              size="sm"
              class="justify-between pl-3 pr-0"
              (click)="changeSession(session)"
            >
              <div class="truncate">
                {{ session.name }}
              </div>
              <button
                hlmBtn
                variant="float"
                size="icon"
                [brnMenuTriggerFor]="menu"
              >
                <hlm-icon size="xs" name="lucideEllipsisVertical" />
              </button>
              <hlm-dialog class="absolute">
                <!-- session options menu -->
                <ng-template #menu>
                  <hlm-menu>
                    <button
                      hlmMenuItem
                      brnDialogTrigger
                      (click)="newSessionName = session.name"
                    >
                      <hlm-icon name="lucidePencil" hlmMenuIcon />
                      Rename
                    </button>
                    <button
                      hlmMenuItem
                      class="text-destructive hover:text-destructive"
                      (click)="deleteSession(session)"
                    >
                      <hlm-icon name="lucideTrash2" hlmMenuIcon />
                      Delete
                    </button>
                  </hlm-menu>
                </ng-template>
                <!-- rename session dialog -->
                <hlm-dialog-content *brnDialogContent="let ctx">
                  <hlm-dialog-header>
                    <div hlmDialogTitle>Rename Session</div>
                  </hlm-dialog-header>
                  <input
                    hlmInput
                    size="sm"
                    class="w-96"
                    [(ngModel)]="newSessionName"
                  />
                  <hlm-dialog-footer>
                    <button hlmBtn brnDialogClose variant="outline" size="sm">Cancel</button>
                    <button
                      hlmBtn
                      brnDialogClose
                      variant="secondary"
                      size="sm"
                      (click)="renameSession(session)"
                    >
                      Save
                    </button>
                  </hlm-dialog-footer>
                </hlm-dialog-content>
              </hlm-dialog>
            </button>
          }
        }
      </div>
    }
    <!-- project settings button -->
    <button
      hlmBtn
      variant="ghost"
      size="sm"
      class="flex-none justify-start mt-auto pl-2 gap-x-2"
    >
      <hlm-icon size="sm" name="lucideSettings" class="flex-none" />
      @if (!collapsed) {
        <div class="truncate">Project Settings</div>
      }
    </button>
  </div>
  <!-- chat interface -->
  <div
    id="main-content"
    class="flex flex-col px-4 py-3 bg-foreground rounded-md gap-y-2"
  >
    <!-- top header row -->
    <div class="flex-none flex -mx-1 items-center gap-x-1">
      <button
        hlmBtn
        variant="ghost"
        size="icon"
        (click)="router.navigate(['dashboard'])"
      >
        <hlm-icon size="sm" name="lucideHouse" />
      </button>
      <div hlmSmall hlmMuted class="truncate overflow-visible">
        / {{ this.currentProject.name }} /
        {{ this.currentSession.name }}
      </div>
      <button hlmBtn variant="ghost" size="icon" class="ml-auto">
        <hlm-icon size="sm" name="lucideCircleStop" />
      </button>
      <button hlmBtn variant="ghost" size="icon">
        <hlm-icon size="sm" name="lucideRotateCw" />
      </button>
    </div>
    <!-- message screen -->
    <div class="flex flex-col h-full gap-y-3 overflow-y-auto">
      @for (message of this.currentSession.history.slice(1); track $index) {
        <!-- display user messages -->
        @if (message.role === "user") {
          <div
            hlmSmall
            class="self-end max-w-[calc(100%-40px)] px-2 py-1 bg-accent rounded-lg break-words"
          >
            {{ message.content }}
          </div>
        }
        <!-- display assistant messages -->
        @else if (
          message.type === "text" ||
          message.type === "code" ||
          message.type === "plan"
        ) {
          <div class="flex gap-x-2.5">
            <!-- twocube avatar -->
            <img
              src="assets/twocube-logo-black-bg.png"
              class="h-9 rounded-lg"
            />
            <!-- twocube name/message -->
            <div class="flex flex-col gap-y-0.5">
              <div hlmLarge hlmSmall>Twocube</div>
              <div hlmSmall class="self-start rounded-lg break-words">
                {{
                  message.type === "code"
                    ? "I've put our code in the code editor! Let me know what you think."
                    : message.type === "plan"
                      ? "I've put our plan in the planner! Let me know what you think."
                      : message.content
                }}
                @if (message.type === "code") {
                  <div
                    [innerHTML]="extractTextWithoutCode(message.content).trim()"
                  ></div>
                }
              </div>
            </div>
          </div>
        }
      }
      <!-- empty session state -->
      @empty {
        @if (!responseLoading) {
          <img
            src="assets/twocube-logo-black-bg.png"
            class="self-center h-12 mt-auto rounded-lg"
          />
          <div hlmSmall hlmMuted class="self-center mb-auto text-center">
            Hello, how can I help you today?
          </div>
        }
      }
      <!-- loading state -->
      @if (responseLoading) {
        <div class="flex pb-1 justify-center gap-x-2">
          <div hlmSmall hlmMuted class="break-words">Waiting for agent...</div>
          <hlm-spinner size="xs" />
        </div>
      }
    </div>
    <!-- chat bar -->
    <div class="flex-none relative mt-auto">
      <!-- using event-binding voodoo to make the textarea dynamically resize. -->
      <textarea
        #chatBar
        hlmInput
        placeholder="Ask Twocube... (shift + enter for new line)"
        class="w-full max-h-40 pr-10 py-2.5 bg-accent border-0"
        [(ngModel)]="newMessage"
        (keydown.enter)="$event.preventDefault(); sendMessage()"
        (keyup.enter)="adjustTextareaHeight(chatBar)"
        (input)="adjustTextareaHeight(chatBar)"
      ></textarea>
      <button
        hlmBtn
        variant="float"
        size="icon"
        class="absolute bottom-1 right-1"
        (mousedown)="sendMessage()"
        (mouseup)="adjustTextareaHeight(chatBar)"
      >
        <hlm-icon size="sm" name="lucideSendHorizontal" />
      </button>
    </div>
  </div>
  <!-- twocube den -->
  <hlm-tabs
    id="den-sidebar"
    tab="planner"
    class="flex flex-col p-3 bg-foreground rounded-md"
  >
    <!-- header tab buttons -->
    <hlm-tabs-list class="w-full grid grid-cols-4">
      <button hlmTabsTrigger="planner">Planner</button>
      <button hlmTabsTrigger="terminal">Terminal</button>
      <button hlmTabsTrigger="code">Code</button>
      <button hlmTabsTrigger="files">Files</button>
    </hlm-tabs-list>
    <!-- planner tab content -->
    <div hlmTabsContent="planner" class="h-full overflow-y-auto">
      @for (
        message of this.currentSession.history | planmessage;
        track $index
      ) {
        @if (parseJson(message.content); as plan) {
          <div
            class="flex flex-col p-3 border rounded-md break-words"
            [ngClass]="{
              'mt-3': !$first,
            }"
          >
            <!-- plan overview -->
            <h2 hlmH2>Plan Overview</h2>
            <p hlmP>
              {{ plan.overview }}
            </p>
            <!-- plan steps -->
            <h2 hlmH2>Required Steps</h2>
            @for (step of plan.steps; track $index) {
              <h3 hlmH3>Step {{ step.step_number }}: {{ step.title }}</h3>
              <ul hlmUl>
                <li><strong>Description: </strong>{{ step.description }}</li>
                <li>
                  <strong>Dependencies: </strong
                  >{{
                    step.dependencies ? step.dependencies.join(", ") : "None"
                  }}
                </li>
                <li>
                  <strong>Expected Output: </strong>{{ step.expected_output }}
                </li>
              </ul>
            }
            <!-- final check -->
            <h2 hlmH2>Final Check</h2>
            <p hlmP>
              {{ plan.final_check }}
            </p>
          </div>
        }
      }
      <!-- empty state -->
      @empty {
        <div
          class="flex flex-col justify-center items-center h-full p-3 border rounded-md gap-y-4"
        >
          <div class="w-20 h-20 bg-background rounded-full"></div>
          <div hlmSmall hlmMuted>Nothing to plan yet.</div>
        </div>
      }
    </div>
    <!-- terminal tab content -->
    <div hlmTabsContent="terminal" class="h-full overflow-y-auto">
      <!-- empty state -->
      <div
        class="flex flex-col justify-center items-center h-full p-3 border rounded-md gap-y-4"
      >
        <div class="w-20 h-20 bg-background rounded-full"></div>
        <div hlmSmall hlmMuted>Terminal coming soon!</div>
      </div>
    </div>
    <!-- code tab content -->
    <div hlmTabsContent="code" class="h-full overflow-y-auto">
      <div class="flex flex-col gap-y-3 h-full">
        @for (
          message of this.currentSession.history | codemessage;
          track $index
        ) {
          <!-- code block -->
          @if (message.type === "code") {
            <pre><code hlmSmall [highlight]="extractCode(message.content)" language="python" class="bg-transparent border rounded-md"></code></pre>
          }
          <!-- result block -->
          @else if (message.type === "result") {
            <pre><code hlmSmall [highlight]="message.content" language="html" class="bg-transparent border rounded-md"></code></pre>
          }
          <!-- image block -->
          @else if (message.type === "image") {
            <img
              [src]="message.content"
              class="max-h-72 border rounded-md object-contain"
            />
          }
          <!-- error block -->
          @else if (message.type === "error") {
            <pre><code hlmSmall [highlight]="message.content" language="python" class="bg-transparent border rounded-md text-destructive"></code></pre>
          }
        }
        <!-- empty state -->
        @empty {
          @if (!executingCode) {
            <div
              class="flex flex-col justify-center items-center h-full p-3 border rounded-md gap-y-4"
            >
              <div class="w-20 h-20 bg-background rounded-full"></div>
              <div hlmSmall hlmMuted>Nothing to code yet.</div>
            </div>
          }
        }
        @if (executingCode) {
          <span
            hlmCode
            class="flex items-center mb-1 p-2 bg-transparent border rounded-md gap-x-3"
          >
            Executing code...
            <hlm-spinner size="xs" />
          </span>
        }
      </div>
    </div>
    <!-- files tab content -->
    <div hlmTabsContent="files" class="h-full overflow-y-auto">
      <div
        class="flex flex-col h-full p-3 border rounded-md gap-y-1.5 overflow-x-auto"
      >
        <div hlmSmall class="text-destructive">
          Warning: This feature is currently in development and files do not
          persist after refresh.
        </div>
        <!-- files list -->
        @for (
          file of this.fileStorageService.getFiles() | async;
          track file.id
        ) {
          <div class="flex items-center gap-x-2">
            <hlm-icon
              size="sm"
              [name]="getLucideIconFromType(file.type)"
              class="flex-none"
            />
            <div hlmSmall class="truncate">{{ file.name }}</div>
            <!-- file not added state, potentially loading -->
            @if (!uploadedFiles.has(file.id)) {
              <button
                hlmBtn
                hlmSmall
                variant="ghost"
                size="xs"
                class="flex-none ml-auto gap-x-2"
                (click)="
                  addFirebaseFileToSandbox(file);
                  icon.name = 'lucideLoaderCircle';
                  icon.class = 'animate-spin'
                "
              >
                Add to project
                <hlm-icon #icon size="xs" name="lucideArrowUpFromLine" />
              </button>
            }
            <!-- file already added state -->
            @else {
              <button
                hlmBtn
                hlmSmall
                variant="ghost"
                size="xs"
                class="flex-none ml-auto gap-x-2 text-green-500"
                (click)="addFirebaseFileToSandbox(file)"
              >
                File added
                <hlm-icon size="xs" name="lucideCheck" />
              </button>
            }
          </div>
        }
        <!-- empty state -->
        @empty {
          <div
            class="self-center w-20 h-20 mt-auto bg-background rounded-full"
          ></div>
          <div hlmSmall hlmMuted class="self-center mb-auto text-center">
            No files found.
          </div>
        }
      </div>
    </div>
  </hlm-tabs>
</div>
